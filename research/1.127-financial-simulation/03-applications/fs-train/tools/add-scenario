#!/usr/bin/env python3
"""
Add a new financial statement scenario to fs-train

Usage:
    ./tools/add-fs-scenario scenario.yaml
    ./tools/add-fs-scenario --interactive
    ./tools/add-fs-scenario --template > new_scenario.yaml

Creates a new scenario file in:
    research/1.127-financial-simulation/03-applications/fs-train/scenarios/

The file is automatically discovered by the launcher on next run.
"""

import sys
import yaml
import argparse
from pathlib import Path
from glob import glob


SCENARIO_TEMPLATE = """# Scenario {number}: {name}
# Difficulty: {difficulty}
# Concept: {concept}

scenario_id: {scenario_id}
name: "{company_name}"
industry: {industry}
stage: {stage}
difficulty: {difficulty}
duration_months: 3

company_context:
  description: "{description}"
  employees: {employees}
  founded: "{founded}"
  funding: "{funding}"

financial_data:
  revenue:
    jan: 50000
    feb: 55000
    mar: 60000

  cogs:
    jan: 15000
    feb: 16500
    mar: 18000

  opex:
    salaries:
      jan: 30000
      feb: 30000
      mar: 30000
    marketing:
      jan: 5000
      feb: 5000
      mar: 5000
    rent:
      jan: 3000
      feb: 3000
      mar: 3000
    other:
      jan: 2000
      feb: 2000
      mar: 2000

learning_objectives:
  - "Identify revenue trends"
  - "Calculate gross margin"
  - "Evaluate operating leverage"

key_observations:
  revenue:
    - "revenue growing"
    - "10% growth"
    - "consistent growth"
  margin:
    - "stable margins"
    - "70% gross margin"
  profitability:
    - "profitable"
    - "positive net income"

hints:
  - text: "Look at revenue growth rate"
    trigger_after_seconds: 30
  - text: "Calculate gross margin percentage"
    trigger_after_seconds: 60
  - text: "Compare operating expenses to revenue"
    trigger_after_seconds: 90
"""


def get_next_scenario_number(scenarios_dir: Path) -> int:
    """Get the next scenario number"""
    existing = glob(str(scenarios_dir / "*.yaml"))
    existing = [f for f in existing if not f.endswith('README.yaml')]

    if not existing:
        return 1

    # Extract numbers from filenames (e.g., 001_simple_growth.yaml -> 1)
    numbers = []
    for filepath in existing:
        filename = Path(filepath).name
        if filename[0].isdigit():
            num_str = filename.split('_')[0]
            try:
                numbers.append(int(num_str))
            except ValueError:
                continue

    return max(numbers) + 1 if numbers else 1


def generate_template(number: int = None) -> str:
    """Generate a scenario template"""
    if number is None:
        number = "XXX"

    return SCENARIO_TEMPLATE.format(
        number=number,
        name="Scenario Name",
        difficulty="beginner",
        concept="Brief description of key concept",
        scenario_id=f"{number:03d}_scenario_slug" if isinstance(number, int) else "XXX_scenario_slug",
        company_name="Company Name",
        industry="SaaS",
        stage="Early Growth",
        description="Brief company description",
        employees=8,
        founded="18 months ago",
        funding="Bootstrapped"
    )


def validate_scenario(scenario_dict: dict) -> bool:
    """Validate scenario structure"""
    required_fields = [
        'scenario_id', 'name', 'industry', 'difficulty',
        'company_context', 'financial_data', 'learning_objectives', 'key_observations'
    ]

    for field in required_fields:
        if field not in scenario_dict:
            print(f"❌ Error: Missing required field: {field}")
            return False

    # Validate financial data has required months
    if 'financial_data' in scenario_dict:
        required_sections = ['revenue', 'cogs', 'opex']
        for section in required_sections:
            if section not in scenario_dict['financial_data']:
                print(f"❌ Error: Missing financial_data.{section}")
                return False

    return True


def add_scenario(input_file: Path, scenarios_dir: Path, scenario_number: int = None):
    """Add a new scenario to fs-train"""

    # Read and parse YAML
    if not input_file.exists():
        print(f"❌ Error: Input file not found: {input_file}")
        sys.exit(1)

    print(f"Reading {input_file}...")
    try:
        with open(input_file, 'r') as f:
            scenario_dict = yaml.safe_load(f)
    except yaml.YAMLError as e:
        print(f"❌ Error: Invalid YAML: {e}")
        sys.exit(1)

    # Validate
    print("Validating scenario structure...")
    if not validate_scenario(scenario_dict):
        sys.exit(1)

    print("✓ Validation passed")

    # Determine scenario number
    if scenario_number is None:
        scenario_number = get_next_scenario_number(scenarios_dir)

    # Extract slug from scenario_id or create from name
    if 'scenario_id' in scenario_dict:
        slug = scenario_dict['scenario_id'].split('_', 1)[-1] if '_' in scenario_dict['scenario_id'] else scenario_dict['scenario_id']
    else:
        # Create slug from name
        slug = scenario_dict.get('name', 'scenario').lower().replace(' ', '_')
        slug = ''.join(c for c in slug if c.isalnum() or c == '_')

    # Create filename
    filename = f"{scenario_number:03d}_{slug}.yaml"
    output_file = scenarios_dir / filename

    if output_file.exists():
        overwrite = input(f"⚠️  {filename} already exists. Overwrite? [y/N] ").strip().lower()
        if overwrite not in ('y', 'yes'):
            print("Cancelled.")
            return

    # Update scenario_id to match filename
    scenario_dict['scenario_id'] = f"{scenario_number:03d}_{slug}"

    # Write to scenarios directory
    print(f"Writing to {output_file}...")
    with open(output_file, 'w') as f:
        yaml.dump(scenario_dict, f, default_flow_style=False, sort_keys=False)

    print()
    print("=" * 70)
    print("✅ Scenario added successfully!")
    print("=" * 70)
    print(f"File: {output_file}")
    print(f"Scenario ID: {scenario_dict['scenario_id']}")
    print(f"Name: {scenario_dict['name']}")
    print()
    print("Next steps:")
    print("  1. Review the scenario file to ensure accuracy")
    print("  2. Test with: ./run-fs-train " + scenario_dict['scenario_id'])
    print("  3. Or use the launcher:")
    print("     ./launch-project")
    print("     → Select 'Financial Statement Analysis Trainer'")
    print("     → Choose 'Run scenario (select file)'")
    print(f"     → The new scenario '{filename}' will appear in the menu")


def interactive_mode(scenarios_dir: Path):
    """Interactive mode for adding scenarios"""
    print()
    print("=" * 70)
    print("Add FS Scenario - Interactive Mode")
    print("=" * 70)
    print()

    # Get next number
    next_num = get_next_scenario_number(scenarios_dir)
    print(f"Next scenario number: {next_num:03d}")
    print()

    # Option 1: From file
    print("Options:")
    print("  1. Import from YAML file")
    print("  2. Generate template to edit")
    print("  3. Cancel")
    print()

    choice = input("Choose [1-3]: ").strip()

    if choice == '1':
        input_path = input("\nPath to scenario YAML file: ").strip()
        input_file = Path(input_path)

        if not input_file.exists():
            print(f"❌ Error: File not found: {input_file}")
            return

        add_scenario(input_file, scenarios_dir, next_num)

    elif choice == '2':
        template = generate_template(next_num)
        output_file = scenarios_dir / f"{next_num:03d}_new_scenario_EDIT_ME.yaml"

        with open(output_file, 'w') as f:
            f.write(template)

        print()
        print(f"✅ Template created: {output_file}")
        print()
        print("Next steps:")
        print(f"  1. Edit {output_file.name}")
        print("  2. Fill in the details (replace placeholder values)")
        print("  3. Run this script again to import:")
        print(f"     ./tools/add-fs-scenario {output_file}")

    else:
        print("Cancelled.")


def main():
    parser = argparse.ArgumentParser(
        description="Add new financial statement scenario to fs-train"
    )
    parser.add_argument(
        'input_file',
        nargs='?',
        help="Path to scenario YAML file"
    )
    parser.add_argument(
        '--interactive',
        '-i',
        action='store_true',
        help="Interactive mode with prompts"
    )
    parser.add_argument(
        '--template',
        '-t',
        action='store_true',
        help="Output scenario template to stdout"
    )
    parser.add_argument(
        '--number',
        '-n',
        type=int,
        help="Force specific scenario number"
    )

    args = parser.parse_args()

    # Template mode
    if args.template:
        print(generate_template())
        return

    # Find scenarios directory (relative to this script)
    script_dir = Path(__file__).parent
    scenarios_dir = script_dir.parent / "scenarios"

    if not scenarios_dir.exists():
        print(f"❌ Error: Scenarios directory not found: {scenarios_dir}")
        print(f"   Expected at: {scenarios_dir.resolve()}")
        sys.exit(1)

    # Interactive mode
    if args.interactive or not args.input_file:
        interactive_mode(scenarios_dir)
        return

    # Command-line mode
    input_file = Path(args.input_file)
    add_scenario(input_file, scenarios_dir, args.number)


if __name__ == "__main__":
    main()
