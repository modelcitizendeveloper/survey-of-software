#!/usr/bin/env python3
"""
Add a new Latin exercise corpus to the trainer

Usage:
    ./tools/add-latin-exercise raw_text.txt caesar_gallic_wars
    ./tools/add-latin-exercise --interactive

Creates a parsed JSONL file in:
    research/1.140-classical-language-libraries/03-cli-utilities/corpus/

The file is automatically discovered by the launcher on next run.
"""

import sys
import json
import argparse
from pathlib import Path


def parse_latin_text(text: str) -> list:
    """
    Parse Latin text using CLTK
    Returns list of parsed sentences

    NOTE: This requires CLTK to be installed and configured.
    See research/1.140-classical-language-libraries/03-cli-utilities/bin/latin-parse
    for the full implementation.
    """
    try:
        # Import CLTK components
        from cltk import NLP
        from cltk.languages.example_texts import get_example_text

        # Initialize Latin NLP pipeline
        nlp = NLP(language="lat", suppress_banner=True)

        # Process text
        doc = nlp.analyze(text=text)

        parsed_sentences = []
        for sentence in doc.sentences:
            words_data = []
            for word in sentence:
                word_dict = {
                    "text": word.string,
                    "lemma": word.lemma if word.lemma else word.string,
                    "pos": word.upos if word.upos else "UNKNOWN",
                }

                # Add morphological features if available
                if hasattr(word, 'xpos') and word.xpos:
                    word_dict["xpos"] = word.xpos

                # Add case, declension, tense if identifiable
                if word.upos in ('NOUN', 'PROPN', 'ADJ'):
                    if hasattr(word, 'features') and word.features:
                        # Extract case from features
                        if 'Case' in word.features:
                            case_map = {
                                'Nom': 'nominative', 'Gen': 'genitive',
                                'Dat': 'dative', 'Acc': 'accusative',
                                'Abl': 'ablative', 'Voc': 'vocative'
                            }
                            word_dict['case'] = case_map.get(word.features['Case'], word.features['Case'])

                if word.upos == 'VERB':
                    if hasattr(word, 'features') and word.features:
                        if 'Tense' in word.features:
                            tense_map = {
                                'Pres': 'present', 'Imp': 'imperfect',
                                'Fut': 'future', 'Perf': 'perfect'
                            }
                            word_dict['tense'] = tense_map.get(word.features['Tense'], word.features['Tense'])

                words_data.append(word_dict)

            parsed_sentences.append({
                "sentence": sentence.string,
                "words": words_data
            })

        return parsed_sentences

    except ImportError:
        print("❌ Error: CLTK not installed")
        print("   Install with: uv pip install cltk")
        print("   Then download models: python -c 'from cltk import NLP; NLP(language=\"lat\")'")
        sys.exit(1)
    except Exception as e:
        print(f"❌ Error parsing Latin text: {e}")
        sys.exit(1)


def add_exercise(input_file: Path, exercise_name: str, corpus_dir: Path):
    """Add a new exercise to the corpus"""

    # Read input text
    if not input_file.exists():
        print(f"❌ Error: Input file not found: {input_file}")
        sys.exit(1)

    print(f"Reading {input_file}...")
    text = input_file.read_text()

    # Parse Latin text
    print("Parsing Latin text with CLTK...")
    parsed_sentences = parse_latin_text(text)

    print(f"✓ Parsed {len(parsed_sentences)} sentences")

    # Write to corpus
    output_file = corpus_dir / f"{exercise_name}.jsonl"

    if output_file.exists():
        overwrite = input(f"⚠️  {output_file.name} already exists. Overwrite? [y/N] ").strip().lower()
        if overwrite not in ('y', 'yes'):
            print("Cancelled.")
            return

    print(f"Writing to {output_file}...")
    with open(output_file, 'w') as f:
        for sentence in parsed_sentences:
            json.dump(sentence, f)
            f.write('\n')

    print()
    print("=" * 70)
    print("✅ Exercise added successfully!")
    print("=" * 70)
    print(f"File: {output_file}")
    print(f"Sentences: {len(parsed_sentences)}")
    print()
    print("Next steps:")
    print("  1. Review the parsed file to ensure accuracy")
    print("  2. Run the launcher: ./launch-project")
    print("  3. Select 'Latin Grammar Trainer'")
    print("  4. Choose 'Interactive trainer (select corpus)'")
    print(f"  5. The new exercise '{exercise_name}.jsonl' will appear in the menu")


def interactive_mode(corpus_dir: Path):
    """Interactive mode for adding exercises"""
    print()
    print("=" * 70)
    print("Add Latin Exercise - Interactive Mode")
    print("=" * 70)
    print()

    # Get input file
    input_path = input("Path to raw Latin text file: ").strip()
    input_file = Path(input_path)

    if not input_file.exists():
        print(f"❌ Error: File not found: {input_file}")
        return

    # Get exercise name
    print()
    print("Exercise name (used for filename)")
    print("Examples: caesar_gallic_wars, cicero_letters, ovid_metamorphoses")
    exercise_name = input("Name: ").strip()

    if not exercise_name:
        print("❌ Error: Name required")
        return

    # Sanitize name (replace spaces/special chars with underscores)
    exercise_name = exercise_name.replace(' ', '_').replace('-', '_')
    exercise_name = ''.join(c for c in exercise_name if c.isalnum() or c == '_')

    print()
    print("Summary:")
    print(f"  Input: {input_file}")
    print(f"  Output: corpus/{exercise_name}.jsonl")
    print()

    confirm = input("Proceed? [Y/n] ").strip().lower()
    if confirm and confirm not in ('y', 'yes'):
        print("Cancelled.")
        return

    add_exercise(input_file, exercise_name, corpus_dir)


def main():
    parser = argparse.ArgumentParser(
        description="Add new Latin exercise corpus to trainer"
    )
    parser.add_argument(
        'input_file',
        nargs='?',
        help="Path to raw Latin text file"
    )
    parser.add_argument(
        'exercise_name',
        nargs='?',
        help="Name for the exercise (used in filename)"
    )
    parser.add_argument(
        '--interactive',
        '-i',
        action='store_true',
        help="Interactive mode with prompts"
    )

    args = parser.parse_args()

    # Find corpus directory (relative to this script)
    script_dir = Path(__file__).parent
    corpus_dir = script_dir.parent / "corpus"

    if not corpus_dir.exists():
        print(f"❌ Error: Corpus directory not found: {corpus_dir}")
        print(f"   Expected at: {corpus_dir.resolve()}")
        sys.exit(1)

    # Interactive mode
    if args.interactive or (not args.input_file and not args.exercise_name):
        interactive_mode(corpus_dir)
        return

    # Command-line mode
    if not args.input_file or not args.exercise_name:
        parser.print_help()
        sys.exit(1)

    input_file = Path(args.input_file)
    add_exercise(input_file, args.exercise_name, corpus_dir)


if __name__ == "__main__":
    main()
