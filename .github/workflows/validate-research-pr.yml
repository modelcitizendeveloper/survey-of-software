name: Validate Research PR

on:
  pull_request:
    paths:
      - 'packages/research/**'

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Extract research codes from PR
        id: extract
        run: |
          # Get changed files in packages/research/
          codes=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | \
            grep "^packages/research/" | \
            cut -d'/' -f3 | \
            cut -d'-' -f1 | \
            sort -u | \
            tr '\n' ' ')

          if [ -z "$codes" ]; then
            echo "No research changes detected"
            echo "codes=" >> $GITHUB_OUTPUT
          else
            echo "Found research codes: $codes"
            echo "codes=$codes" >> $GITHUB_OUTPUT
          fi

      - name: Validate research quality
        if: steps.extract.outputs.codes != ''
        id: validate
        run: |
          all_passed=true
          results=""

          for code in ${{ steps.extract.outputs.codes }}; do
            echo "::group::Validating $code"

            if output=$(python3 scripts/validate_research.py "$code" 2>&1); then
              echo "$output"
              score=$(echo "$output" | grep "Overall Score" | grep -oP '\d+(?=%)' || echo "0")

              if [ "$score" -ge 90 ]; then
                status="✅ EXCELLENT"
              elif [ "$score" -ge 75 ]; then
                status="✅ GOOD"
              else
                status="❌ FAILED"
                all_passed=false
              fi

              results="$results\n- **$code**: ${score}% - $status"
            else
              echo "Validation script failed for $code"
              results="$results\n- **$code**: ❌ Validation error"
              all_passed=false
            fi

            echo "::endgroup::"
          done

          echo "results<<EOF" >> $GITHUB_OUTPUT
          echo -e "$results" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if [ "$all_passed" = false ]; then
            exit 1
          fi

      - name: Comment validation results
        if: always() && steps.extract.outputs.codes != ''
        uses: actions/github-script@v7
        with:
          script: |
            const results = `${{ steps.validate.outputs.results }}`;
            const status = '${{ steps.validate.outcome }}';

            const body = status === 'success'
              ? `## ✅ Research Validation Passed\n\n${results}\n\nAll research meets quality standards (75%+).`
              : `## ❌ Research Validation Failed\n\n${results}\n\n**Action required**: Research must score 75%+ to merge.\n\nRun locally:\n\`\`\`bash\npython3 scripts/validate_research.py <code>\n\`\`\``;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail if validation failed
        if: steps.validate.outcome == 'failure'
        run: |
          echo "❌ One or more research pieces failed validation"
          echo "Research must score 75%+ to be merged"
          exit 1
