name: Auto-Integrate Research

on:
  push:
    branches: [main]
    paths:
      - 'packages/research/**'

# Prevent infinite loop: don't trigger on commits by github-actions bot
# Only trigger on commits that actually change research content

jobs:
  integrate:
    runs-on: ubuntu-latest
    # Skip if commit author is github-actions bot (prevents infinite loop)
    if: github.actor != 'github-actions[bot]'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit to detect changes
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Detect new research
        id: detect
        run: |
          # Find research codes in last commit
          codes=$(git diff --name-only HEAD~1 HEAD | \
            grep "^packages/research/" | \
            cut -d'/' -f3 | \
            cut -d'-' -f1 | \
            sort -u | \
            tr '\n' ' ')

          if [ -z "$codes" ]; then
            echo "No new research found in last commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Found new research: $codes"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "codes=$codes" >> $GITHUB_OUTPUT
          fi

      - name: Convert research to docs
        if: steps.detect.outputs.has_changes == 'true'
        run: |
          echo "Converting research to Docusaurus format..."
          python3 scripts/convert_research.py

          # Check if any docs were created/modified
          if git diff --quiet docs/survey/; then
            echo "No docs were generated (may be an update to existing research)"
          else
            echo "âœ“ Docs generated successfully"
          fi

      - name: Integrate into site
        if: steps.detect.outputs.has_changes == 'true'
        run: |
          echo "Integrating research into site..."
          python3 scripts/integrate_research.py

      - name: Check for changes
        id: changes
        if: steps.detect.outputs.has_changes == 'true'
        run: |
          if git diff --quiet docs/survey/ sidebars.ts; then
            echo "No integration changes needed"
            echo "needs_commit=false" >> $GITHUB_OUTPUT
          else
            echo "Integration changes detected"
            echo "needs_commit=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit integration
        if: steps.changes.outputs.needs_commit == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          codes="${{ steps.detect.outputs.codes }}"

          git add docs/survey/*.md docs/survey/index.md sidebars.ts

          git commit -m "$(cat <<'EOF'
          docs: Auto-integrate research ${codes}

          Automated conversion and integration:
          - Converted packages/research/ to docs/survey/
          - Updated survey index with new entries
          - Updated sidebar navigation

          Research codes: ${codes}

          Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
          EOF
          )"

          git push

      - name: Summary
        if: steps.detect.outputs.has_changes == 'true'
        run: |
          if [ "${{ steps.changes.outputs.needs_commit }}" = "true" ]; then
            echo "âœ… Successfully integrated research: ${{ steps.detect.outputs.codes }}"
            echo "ğŸ“ Changes committed and pushed to main"
          else
            echo "â„¹ï¸ Research detected but no integration changes needed"
          fi
